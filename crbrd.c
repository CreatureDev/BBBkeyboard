#include "crbrd.h"
#include "kbrd_gpio.h"
#include <stdio.h>
#include <stdlib.h>

/*
 *	layout
 *	 ____________________________________________________________________________________
 *	| esc| f1 | f2 | f3 | f4 | f5 | f6 | f7 | f8 | f9 | f10| f11| f12|PSCR| SLK|PAUS|SPCL|
 *	| `¬ | 1! | 2@ | 3# | 4$ | 5% | 6^ | 7& | 8* | 9( | 0) | -_ | =+ | BS | INS|HOME|P UP|
 *	| tab|  q |  w |  e |  r |  t |  y |  u |  i |  o |  p | [{ | ]} |ENTR| DEL| END|P DN|
 *	|CPLK|  a |  s |  d |  f |  g |  h |  j |  k |  l | ;: | '" | ~€ | NIL| NIL| NIL| NIL|
 *	|SHFT| \| |  z |  x |  c |  v |  b |  n |  m | ,< | .> | /? |SHFT|SHFT| NIL| UP | NIL|
 *	|CNTL|SUPR| ALT| SPS| NIL| NIL| NIL| NIL| NIL| NIL| ALT|SUPR|MENU|CNTL| <- | DN | -> |
 *
*/

unsigned char nch[6][17] = {
	{0x1b, 0xaf, 0xb0, 0xb1, 0xb2, 0xb3, 0xb4, 0xb5, 0xb6, 0xb7, 0xb8, 0xb9, 0xba, 0xbb, 0xbc, 0xbd, 0xbe},
	{0x60, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x30, 0x2d, 0x3d, 0x08, 0x83, 0x84, 0x85},
	{0x09, 0x71, 0x77, 0x65, 0x72, 0x74, 0x79, 0x75, 0x69, 0x6f, 0x70, 0x5b, 0x5d, 0x0a, 0x7f, 0xb5, 0xfe},
	{0x8c, 0x61, 0x73, 0x64, 0x66, 0x67, 0x68, 0x6a, 0x6b, 0x6c, 0x3b, 0x91, 0x7e, 0x00, 0x00, 0x00, 0x00},
	{0x89, 0x5c, 0x7a, 0x78, 0x63, 0x76, 0x62, 0x6e, 0x6d, 0x2c, 0x2e, 0x2f, 0x8a, 0x8a, 0x00, 0x95, 0x00},
	{0xae, 0xaf, 0xa4, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xb6, 0xb8, 0xb9, 0xcf, 0xd0, 0xd7, 0xdf}};

unsigned char sch[6][17] = {
	{0x1b, 0xaf, 0xb0, 0xb1, 0xb2, 0xb3, 0xb4, 0xb5, 0xb6, 0xb7, 0xb8, 0xb9, 0xba, 0xbb, 0xbc, 0xbd, 0xbe},
	{0x60, 0x21, 0x40, 0x23, 0x24, 0x25, 0x5e, 0x26, 0x2a, 0x28, 0x29, 0x5f, 0x2b, 0x08, 0x83, 0x84, 0x85},
	{0x09, 0x51, 0x57, 0x45, 0x52, 0x54, 0x59, 0x55, 0x49, 0x4f, 0x50, 0x7b, 0x7d, 0x0a, 0x7f, 0xb5, 0xfe},
	{0x8c, 0x41, 0x53, 0x44, 0x46, 0x47, 0x48, 0x4a, 0x4b, 0x4c, 0x3a, 0x42, 0x80, 0x00, 0x00, 0x00, 0x00},
	{0x89, 0x7c, 0x5a, 0x58, 0x43, 0x56, 0x42, 0x4e, 0x4d, 0x3c, 0x3e, 0x3f, 0x8a, 0x8a, 0x00, 0x95, 0x00},
	{0xae, 0xaf, 0xa4, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xb6, 0xb8, 0xb9, 0xcf, 0xd0, 0xd7, 0xdf}};

unsigned char cch[6][17] = {
    {0x1b, 0xaf, 0xb0, 0xb1, 0xb2, 0xb3, 0xb4, 0xb5, 0xb6, 0xb7, 0xb8, 0xb9, 0xba, 0xbb, 0xbc, 0xbd, 0xbe},
    {0x60, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x30, 0x2d, 0x3d, 0x08, 0x83, 0x84, 0x85},
    {0x09, 0x51, 0x57, 0x45, 0x52, 0x54, 0x59, 0x55, 0x49, 0x4f, 0x50, 0x5b, 0x5d, 0x0a, 0x7f, 0xb5, 0xfe},
    {0x8c, 0x41, 0x53, 0x44, 0x46, 0x47, 0x48, 0x4a, 0x4b, 0x4c, 0x3b, 0x91, 0x7e, 0x00, 0x00, 0x00, 0x00},
    {0x89, 0x5c, 0x5a, 0x58, 0x43, 0x56, 0x42, 0x4e, 0x4d, 0x2c, 0x2e, 0x2f, 0x8a, 0x8a, 0x00, 0x95, 0x00},
    {0xae, 0xaf, 0xa4, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xb6, 0xb8, 0xb9, 0xcf, 0xd0, 0xd7, 0xdf}};

unsigned char scch[6][17] = {
    {0x1b, 0xaf, 0xb0, 0xb1, 0xb2, 0xb3, 0xb4, 0xb5, 0xb6, 0xb7, 0xb8, 0xb9, 0xba, 0xbb, 0xbc, 0xbd, 0xbe},
    {0x60, 0x21, 0x40, 0x23, 0x24, 0x25, 0x5e, 0x26, 0x2a, 0x28, 0x29, 0x5f, 0x2b, 0x08, 0x83, 0x84, 0x85},
    {0x09, 0x71, 0x77, 0x65, 0x72, 0x74, 0x79, 0x75, 0x69, 0x6f, 0x70, 0x7b, 0x7d, 0x0a, 0x7f, 0xb5, 0xfe},
    {0x8c, 0x61, 0x73, 0x64, 0x66, 0x67, 0x68, 0x6a, 0x6b, 0x6c, 0x3a, 0x42, 0x80, 0x00, 0x00, 0x00, 0x00},
    {0x89, 0x7c, 0x7a, 0x78, 0x63, 0x76, 0x62, 0x6e, 0x6d, 0x3c, 0x3e, 0x3f, 0x8a, 0x8a, 0x00, 0x95, 0x00},
    {0xae, 0xaf, 0xa4, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xb6, 0xb8, 0xb9, 0xcf, 0xd0, 0xd7, 0xdf}};

unsigned char ctrl_key[6][17] = {
	{0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0},
	{0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0},
	{0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0},
	{CPLK, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0},
	{SHFT, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, SHFT, SHFT, 0, 0, 0},
	{CTRL, SUPR, ALT, 0, 0, 0, 0, 0, 0, 0, ALT, SUPR, MENU, CTRL, 0, 0, 0}};	

unsigned char *ps;
unsigned char *rs;

unsigned char *p;
unsigned char *r;
brd crbrd;

void init_crbrd()
{
	int i, j;
	crbrd.s = 0;
	for(i = 0; i < 6; i++)
	{
		for(j = 0; i < 17; i++)
		{
			crbrd.key[i][j] = 0;
		}
	}
/*	for(i = 0; i < 17; i++)
	{
		crbrd.key[0][i].st = 0;
		crbrd.key[0][i].v = row0_v[i];
	}
	for(i = 0; i < 17; i++)
    {
		crbrd.key[1][i].st = 0;
        crbrd.key[1][i].v = row1_v[i];
    }
	for(i = 0; i < 17; i++)
    {
		crbrd.key[2][i].st = 0;
        crbrd.key[2][i].v = row2_v[i];
    }
	for(i = 0; i < 17; i++)
    {
		crbrd.key[3][i].st = 0;
        crbrd.key[3][i].v = row3_v[i];
    }
	for(i = 0; i < 17; i++)
    {
		crbrd.key[4][i].st = 0;
        crbrd.key[4][i].v = row4_v[i];
    }
	for(i = 0; i < 17; i++)
    {
		crbrd.key[5][i].st = 0;
        crbrd.key[5][i].v = row5_v[i];
    }
*/	ps = (char *) malloc(89);
	ps += 89;
	p = ps;
	rs = (char *) malloc(89);
	rs += 89;
	r = rs;
}

void fallst(unsigned char rw, unsigned char cl)
{
	if(ctrl_key[rw][cl] == CPLK)
	{
		crbrd.s ^= CPLK;
	}
}

void risest(unsigned char rw, unsigned char cl)
{

}

void upst()
{
	crbrd.s &= CPLK;
	if(crbrd.key[4][0] || crbrd.key[4][12] || crbrd.key[4][13])
		crbrd.s |= SHFT;

	if(crbrd.key[5][0] || crbrd.key[5][13])
		crbrd.s |= CTRL;
	
	if(crbrd.key[5][2] || crbrd.key[5][10])
		crbrd.s |= ALT;
	
	if(crbrd.key[5][1] || crbrd.key[5][11])
		crbrd.s |= SUPR;

	if(crbrd.key[5][12])
		crbrd.s |= MENU;
}

void scan_crbrd()
{
	unsigned char i, j, t, *cur;
	r = rs;
	p = ps;
	for(j = 0; j < 17; j++)
	{
		set_col(j);
		usleep(100);
		t = get_rows();
		for(i = 0; i < 6; i++)
		{	
			cur = &(crbrd.key[i][j]);
			if(t & (1<<i))
			{	
				if(*cur == 0)
				{	
					*cur = 1;
					if(ctrl_key[i][j])
					{
						fallst(i, j);
					}
					else
					{	
						p--;
						*p = (i * 0x20) + j;
					}
				}
			}
			else
			{
				if(*cur == 1)
				{
					*cur = 0;
					if(ctrl_key[i][j])
					{
						risest(i, j);
					}
					else
					{
						r--;
						*r = (i * 0x20) + j;
					}
				}
			}	
		}
		clr_col(j);
	}
	upst();
}



void p_keys()
{
	if(crbrd.s & CPLK)
	{
		if(crbrd.s & SHFT)
		{
			while(p < ps)
			{
				printf("%c", scch[(*p/0x20)][(*p%0x20)]);
				p++;
			}
		}	
		else
		{
			while(p < ps)
			{
				printf("%c", cch[(*p/0x20)][(*p%0x20)]);
				p++;
			}
		}
	}
	else
	if(crbrd.s & SHFT)
	{
		while(p < ps)
		{
			printf("%c", sch[(*p/0x20)][(*p%0x20)]);
			p++;
		}
	}
	else
	{
		while(p < ps)
		{
			printf("%c", nch[(*p/0x20)][(*p%0x20)]);
            p++;
		}
	}
	fflush(stdout);
}
